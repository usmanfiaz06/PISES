<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PISES — Revenue &amp; Cost Projection Simulator</title>
<style>
  :root {
    --dk-green: #01411C; --md-green: #388E3C; --lt-green: #E8F5E9;
    --gold: #C49A2A; --lt-gold: #FFF8E1;
    --dk-grey: #2D2D2D; --md-grey: #757575; --lt-grey: #F7F8FA;
    --border: #D5D9E0; --white: #FFFFFF;
    --red: #C62828; --lt-red: #FFEBEE;
    --blue: #1565C0; --lt-blue: #E3F2FD;
    --orange: #E65100; --lt-orange: #FFF3E0;
    --purple: #7B1FA2; --lt-purple: #F3E5F5;
    --teal: #00796B;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.08), 0 1px 3px rgba(0,0,0,0.06);
    --shadow-lg: 0 8px 24px rgba(0,0,0,0.1), 0 2px 6px rgba(0,0,0,0.06);
    --radius: 10px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: var(--lt-grey); color: var(--dk-grey); line-height: 1.5; }

  /* ── HEADER ──────────────────────────────── */
  .header {
    background: linear-gradient(135deg, #012F14 0%, var(--dk-green) 50%, #015A28 100%);
    color: var(--white); padding: 20px 32px;
    display: flex; justify-content: space-between; align-items: center;
    box-shadow: var(--shadow-lg);
  }
  .header h1 { font-size: 19px; font-weight: 800; letter-spacing: 0.8px; }
  .header .sub { color: var(--gold); font-size: 11px; margin-top: 3px; opacity: 0.9; }
  .header .badge {
    background: linear-gradient(135deg, #D4A72C, var(--gold));
    color: var(--dk-green); padding: 6px 18px; border-radius: 20px;
    font-size: 10px; font-weight: 800; letter-spacing: 1px;
    box-shadow: 0 2px 8px rgba(196,154,42,0.4);
  }

  /* ── LAYOUT ──────────────────────────────── */
  .container { max-width: 1720px; margin: 0 auto; padding: 14px; }
  .grid-3 { display: grid; grid-template-columns: 340px 1fr 370px; gap: 14px; }
  @media (max-width: 1300px) { .grid-3 { grid-template-columns: 1fr; } }
  .left-panel { max-height: calc(100vh - 100px); overflow-y: auto; padding-right: 4px; }
  .left-panel::-webkit-scrollbar { width: 4px; }
  .left-panel::-webkit-scrollbar-thumb { background: var(--md-green); border-radius: 4px; }

  /* ── CARDS ────────────────────────────────── */
  .card { background: var(--white); border-radius: var(--radius); box-shadow: var(--shadow-sm); overflow: hidden; margin-bottom: 12px; transition: box-shadow 0.2s; }
  .card:hover { box-shadow: var(--shadow-md); }
  .card-head {
    padding: 9px 16px; font-size: 10.5px; font-weight: 800; letter-spacing: 0.5px;
    cursor: pointer; user-select: none;
    display: flex; justify-content: space-between; align-items: center;
    background: var(--dk-green); color: var(--white);
  }
  .card-head.gold { background: linear-gradient(135deg, #B8901F, var(--gold)); color: var(--dk-green); }
  .card-head.blue { background: linear-gradient(135deg, #0D47A1, var(--blue)); }
  .card-head.red { background: linear-gradient(135deg, #B71C1C, var(--red)); }
  .card-head.orange { background: linear-gradient(135deg, #BF360C, var(--orange)); }
  .card-head.purple { background: linear-gradient(135deg, #6A1B9A, var(--purple)); }
  .card-head.teal { background: linear-gradient(135deg, #004D40, var(--teal)); }
  .card-head .toggle { font-size: 9px; opacity: 0.6; }
  .card-body { padding: 12px 16px; }
  .card-body.collapsed { display: none; }

  /* ── BENCHMARK HINTS ─────────────────────── */
  .bm { font-size: 8px; font-weight: 600; margin-top: 1px; display: block; line-height: 1.3; }
  .bm-ok { color: var(--md-green); }
  .bm-warn { color: var(--orange); }
  .bm-bad { color: var(--red); }
  .bm-info { color: var(--blue); }
  .dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 3px; vertical-align: middle; }
  .dot-g { background: var(--md-green); }
  .dot-y { background: var(--orange); }
  .dot-r { background: var(--red); }

  /* ── INPUTS ──────────────────────────────── */
  .input-group { margin-bottom: 12px; }
  .input-group label {
    display: flex; justify-content: space-between; align-items: baseline;
    font-size: 11px; font-weight: 600; color: var(--dk-grey); margin-bottom: 3px;
  }
  .input-group label .val { font-size: 12px; font-weight: 800; color: var(--dk-green); }
  .input-group input[type="range"] {
    width: 100%; -webkit-appearance: none; height: 5px; border-radius: 3px;
    background: linear-gradient(to right, var(--md-green), var(--dk-green)); outline: none;
  }
  .input-group input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%;
    background: var(--dk-green); border: 2px solid var(--white);
    box-shadow: 0 1px 4px rgba(0,0,0,0.3); cursor: pointer;
  }

  /* ── FEE TABLE ───────────────────────────── */
  .fee-table { width: 100%; border-collapse: collapse; font-size: 10px; }
  .fee-table th {
    background: var(--lt-green); color: var(--dk-green); padding: 5px 6px;
    font-size: 9px; font-weight: 800; text-align: center; border-bottom: 2px solid var(--md-green);
  }
  .fee-table th:first-child { text-align: left; }
  .fee-table td { padding: 3px 4px; border-bottom: 1px solid #F0F0F0; text-align: center; }
  .fee-table td:first-child { text-align: left; font-weight: 600; font-size: 10px; white-space: nowrap; }
  .fee-table input[type="number"] {
    width: 64px; padding: 4px 5px; border: 1px solid var(--border); border-radius: 4px;
    font-size: 10px; font-family: inherit; text-align: right; transition: all 0.15s;
  }
  .fee-table input[type="number"]:focus { outline: none; border-color: var(--dk-green); box-shadow: 0 0 0 2px rgba(1,65,28,0.15); }
  .fee-table tr.seg-head td { background: var(--lt-gold); font-weight: 800; color: var(--dk-green); font-size: 10px; padding: 5px 6px; }
  .fee-table .bm-cell { font-size: 7px; color: var(--md-grey); text-align: center; }

  /* ── TABS ─────────────────────────────────── */
  .tab-bar { display: flex; background: linear-gradient(135deg, #012F14, var(--dk-green)); border-radius: var(--radius) var(--radius) 0 0; overflow: hidden; }
  .tab-btn {
    flex: 1; padding: 10px 6px; background: transparent; color: rgba(255,255,255,0.5);
    border: none; font-size: 10px; font-weight: 800; cursor: pointer; text-align: center;
    transition: all 0.2s; font-family: inherit; letter-spacing: 0.3px;
  }
  .tab-btn:hover { color: var(--white); background: rgba(255,255,255,0.08); }
  .tab-btn.active { color: var(--gold); background: rgba(255,255,255,0.12); border-bottom: 3px solid var(--gold); }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* ── PROJECTION TABLES ───────────────────── */
  .proj-table { width: 100%; border-collapse: collapse; font-size: 10px; }
  .proj-table th {
    background: var(--dk-green); color: var(--white); padding: 6px 7px;
    font-size: 9px; font-weight: 800; text-align: center; position: sticky; top: 0; z-index: 2;
  }
  .proj-table th:first-child { text-align: left; min-width: 130px; }
  .proj-table td { padding: 5px 7px; border-bottom: 1px solid #EAECEF; text-align: right; font-variant-numeric: tabular-nums; }
  .proj-table td:first-child { text-align: left; font-weight: 600; }
  .proj-table tr:nth-child(even) { background: #FAFBFC; }
  .proj-table tr:hover { background: var(--lt-green) !important; }
  .proj-table tr.seg-head td { background: var(--lt-gold); font-weight: 800; color: var(--dk-green); font-size: 10px; border-bottom: 2px solid var(--gold); text-align: left; }
  .proj-table tr.total-row td { background: var(--dk-green); color: var(--white); font-weight: 800; font-size: 11px; }
  .proj-table tr.subtotal-row td { background: var(--lt-green); font-weight: 700; color: var(--dk-green); }
  .proj-table tr.discount-row td { background: var(--lt-red); color: var(--red); font-weight: 600; }
  .proj-table tr.revenue-row td { background: var(--lt-green); font-weight: 700; color: var(--dk-green); font-size: 11px; }
  .proj-table tr.cost-row td { background: var(--lt-red); font-weight: 700; color: var(--red); font-size: 11px; }
  .proj-table tr.net-row td { background: var(--dk-green); color: var(--gold); font-weight: 800; font-size: 12px; }
  .proj-table .new-hire { color: var(--red); font-weight: 800; }
  .proj-wrap { overflow-x: auto; max-height: 520px; overflow-y: auto; }

  /* ── KPIs ─────────────────────────────────── */
  .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(125px, 1fr)); gap: 8px; margin-bottom: 12px; }
  .kpi { background: var(--white); border-radius: 8px; padding: 10px; text-align: center; box-shadow: var(--shadow-sm); border-left: 4px solid var(--md-green); }
  .kpi .value { font-size: 16px; font-weight: 800; color: var(--dk-green); line-height: 1.2; }
  .kpi .label { font-size: 8px; color: var(--md-grey); margin-top: 2px; font-weight: 600; }
  .kpi-gold { border-left-color: var(--gold); }
  .kpi-gold .value { color: var(--gold); }
  .kpi-red { border-left-color: var(--red); }
  .kpi-red .value { color: var(--red); }
  .kpi-blue { border-left-color: var(--blue); }
  .kpi-blue .value { color: var(--blue); }

  /* ── RIGHT PANEL ─────────────────────────── */
  .summary-row { display: flex; justify-content: space-between; padding: 5px 0; font-size: 11px; border-bottom: 1px solid #F0F0F0; }
  .summary-row:last-child { border-bottom: none; }
  .summary-row .s-label { color: var(--dk-grey); }
  .summary-row .s-val { font-weight: 700; color: var(--dk-green); }
  .summary-row.grand {
    background: linear-gradient(135deg, #012F14, var(--dk-green)); color: var(--white);
    padding: 10px 14px; margin: 8px -16px -12px; border-radius: 0 0 var(--radius) var(--radius);
    font-size: 13px; font-weight: 800;
  }
  .summary-row.grand .s-val { color: var(--gold); }
  .summary-row.deficit .s-val { color: var(--red); }
  .summary-row.surplus .s-val { color: var(--md-green); }

  .hire-item { display: flex; justify-content: space-between; padding: 4px 0; font-size: 10px; border-bottom: 1px solid #F5F5F5; }
  .hire-item .seg { font-weight: 600; }
  .hire-item .count { font-weight: 800; color: var(--red); }
  .hire-item .count.zero { color: var(--md-grey); }

  /* ── MINI CHART ──────────────────────────── */
  .mini-chart { margin: 6px 0; }
  .bar-row { display: flex; align-items: center; margin-bottom: 3px; font-size: 9px; }
  .bar-row .bar-label { width: 26px; font-weight: 800; color: var(--dk-grey); text-align: center; }

  /* ── HEALTH CHECK ────────────────────────── */
  .health-row { display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid #F0F0F0; }
  .health-row:last-child { border-bottom: none; }
  .health-metric { flex: 1; font-size: 10px; font-weight: 600; }
  .health-bar { width: 80px; height: 6px; background: #E0E0E0; border-radius: 3px; overflow: hidden; }
  .health-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
  .health-val { width: 42px; font-size: 10px; font-weight: 800; text-align: right; }
  .health-std { font-size: 7px; color: var(--md-grey); }

  /* ── YEAR SELECTOR ───────────────────────── */
  .year-selector { display: flex; gap: 4px; }
  .year-btn {
    flex: 1; padding: 6px 2px; background: var(--white); border: 2px solid var(--border);
    border-radius: 6px; font-size: 9px; font-weight: 800; cursor: pointer;
    text-align: center; font-family: inherit; transition: all 0.15s;
  }
  .year-btn:hover { border-color: var(--md-green); background: var(--lt-green); }
  .year-btn.active { background: var(--dk-green); color: var(--white); border-color: var(--dk-green); }

  /* ── FOOTER ──────────────────────────────── */
  .footer {
    background: linear-gradient(135deg, #012F14, var(--dk-green)); color: var(--gold);
    text-align: center; padding: 12px; font-size: 9px; margin-top: 16px; font-weight: 600;
  }
  .disclaimer { font-size: 8px; color: var(--md-grey); font-style: italic; margin-top: 8px; line-height: 1.4; }
</style>
</head>
<body>

<div class="header">
  <div>
    <h1>PISES — REVENUE &amp; COST PROJECTION SIMULATOR</h1>
    <div class="sub">Pakistan International School (English Section), Riyadh | New Campus Financial Model</div>
  </div>
  <div class="badge">LIVE PROJECTIONS</div>
</div>

<div class="container">
<div class="grid-3">

<!-- ═══════════ LEFT PANEL ═══════════ -->
<div class="left-panel">

  <div class="card">
    <div class="card-head" onclick="toggleCard(this)">GROWTH TRAJECTORY <span class="toggle">&#9660;</span></div>
    <div class="card-body">
      <div class="input-group">
        <label>Target Enrollment <span class="val" id="lbl-target">7,000</span></label>
        <input type="range" id="sl-target" min="5000" max="10000" step="100" value="7000">
        <span class="bm bm-info">KSA mega-school benchmark: 5,000-8,000 students</span>
      </div>
      <div class="input-group">
        <label>Growth Period (Years) <span class="val" id="lbl-growth-yrs">5</span></label>
        <input type="range" id="sl-growth-yrs" min="1" max="8" step="1" value="5">
      </div>
      <div class="input-group">
        <label>Max Class Size <span class="val" id="lbl-max-cls">25</span></label>
        <input type="range" id="sl-max-cls" min="20" max="35" step="1" value="25">
        <span class="bm bm-info">TBC Category A mandates max 25</span>
      </div>
      <div class="input-group" style="margin-bottom:0;">
        <label>EY Class Size <span class="val" id="lbl-ey-cls">22</span></label>
        <input type="range" id="sl-ey-cls" min="15" max="25" step="1" value="22">
        <span class="bm bm-info">KSA best practice: 18-22 for Early Years</span>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-head gold" onclick="toggleCard(this)">TUITION FEES PER CLASS (SAR / YEAR) <span class="toggle">&#9660;</span></div>
    <div class="card-body">
      <table class="fee-table" id="tuition-table">
        <thead><tr><th>Grade</th><th>Students</th><th>Fee (SAR)</th><th style="font-size:7px;">KSA Range</th></tr></thead>
        <tbody id="tuition-tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="card-head blue" onclick="toggleCard(this)">OTHER FEES PER STUDENT (SAR / YEAR) <span class="toggle">&#9660;</span></div>
    <div class="card-body">
      <table class="fee-table" id="other-fees-table">
        <thead><tr><th>Fee Type</th><th>EY</th><th>PRI</th><th>INT</th><th>SEC</th></tr></thead>
        <tbody id="other-fees-tbody"></tbody>
      </table>
      <div style="margin-top:8px;">
        <div class="input-group">
          <label>Transport Utilization <span class="val" id="lbl-transport-util">45%</span></label>
          <input type="range" id="sl-transport-util" min="0" max="100" step="5" value="45">
          <span class="bm bm-info">Riyadh schools avg: 40-55% bus ridership</span>
        </div>
        <div class="input-group" style="margin-bottom:0;">
          <label>Sports/Activities Opt-in <span class="val" id="lbl-sports-optin">60%</span></label>
          <input type="range" id="sl-sports-optin" min="0" max="100" step="5" value="60">
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-head orange" onclick="toggleCard(this)">NEW BUILDING DISCOUNT <span class="toggle">&#9660;</span></div>
    <div class="card-body">
      <div class="input-group">
        <label>Discount on Tuition <span class="val" id="lbl-discount">10%</span></label>
        <input type="range" id="sl-discount" min="0" max="30" step="1" value="10">
        <span class="bm bm-info" id="bm-discount">KSA new-campus norm: 5-15% for 2-3 yrs</span>
      </div>
      <div class="input-group" style="margin-bottom:0;">
        <label>Discount Duration (Years) <span class="val" id="lbl-disc-yrs">3</span></label>
        <input type="range" id="sl-disc-yrs" min="0" max="6" step="1" value="3">
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-head red" onclick="toggleCard(this)">STAFF COSTS (SAR / MONTH) <span class="toggle">&#9660;</span></div>
    <div class="card-body">
      <div class="input-group">
        <label>Teacher Salary <span class="val" id="lbl-teacher-sal">5,500</span></label>
        <input type="range" id="sl-teacher-sal" min="3000" max="10000" step="250" value="5500">
        <span class="bm" id="bm-teacher-sal">KSA community school: SAR 4,000-7,000/mo</span>
      </div>
      <div class="input-group">
        <label>Senior Teacher / HOD <span class="val" id="lbl-senior-sal">8,000</span></label>
        <input type="range" id="sl-senior-sal" min="5000" max="15000" step="500" value="8000">
        <span class="bm bm-info">KSA range: SAR 6,000-12,000/mo</span>
      </div>
      <div class="input-group">
        <label>Admin Staff <span class="val" id="lbl-admin-sal">5,000</span></label>
        <input type="range" id="sl-admin-sal" min="3000" max="10000" step="250" value="5000">
        <span class="bm bm-info">KSA range: SAR 3,500-7,000/mo</span>
      </div>
      <div class="input-group">
        <label>Support Staff <span class="val" id="lbl-support-sal">3,000</span></label>
        <input type="range" id="sl-support-sal" min="2000" max="6000" step="250" value="3000">
        <span class="bm bm-info">KSA range: SAR 2,500-4,500/mo</span>
      </div>
      <div class="input-group" style="margin-bottom:0;">
        <label>Benefits Multiplier <span class="val" id="lbl-benefits">1.25&times;</span></label>
        <input type="range" id="sl-benefits" min="1.0" max="1.5" step="0.05" value="1.25">
        <span class="bm bm-info">Incl. housing, GOSI, EOS, medical (1.20-1.35&times; typical)</span>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-head purple" onclick="toggleCard(this)">OPERATIONAL COSTS (SAR / STUDENT / YEAR) <span class="toggle">&#9660;</span></div>
    <div class="card-body">
      <div class="input-group">
        <label>Utilities &amp; Energy <span class="val" id="lbl-utilities">1,500</span></label>
        <input type="range" id="sl-utilities" min="500" max="4000" step="100" value="1500">
        <span class="bm bm-info">KSA avg SAR 1,200-2,200 (high cooling load)</span>
      </div>
      <div class="input-group">
        <label>Maintenance <span class="val" id="lbl-maintenance">800</span></label>
        <input type="range" id="sl-maintenance" min="200" max="2000" step="100" value="800">
        <span class="bm bm-info">KSA benchmark: SAR 600-1,200/student</span>
      </div>
      <div class="input-group">
        <label>Materials &amp; Consumables <span class="val" id="lbl-materials">500</span></label>
        <input type="range" id="sl-materials" min="100" max="1500" step="50" value="500">
      </div>
      <div class="input-group" style="margin-bottom:0;">
        <label>Other Overhead <span class="val" id="lbl-overhead">700</span></label>
        <input type="range" id="sl-overhead" min="200" max="2000" step="50" value="700">
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-head" onclick="toggleCard(this)">COLLECTION &amp; ASSUMPTIONS <span class="toggle">&#9660;</span></div>
    <div class="card-body">
      <div class="input-group" style="margin-bottom:0;">
        <label>Fee Collection Rate <span class="val" id="lbl-collection">92%</span></label>
        <input type="range" id="sl-collection" min="70" max="100" step="1" value="92">
        <span class="bm" id="bm-collection">KSA int'l schools: 88-96% typical</span>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════ CENTER PANEL ═══════════ -->
<div>
  <div class="kpi-row" id="top-kpis">
    <div class="kpi kpi-gold"><div class="value" id="kpi-revenue">—</div><div class="label">Annual Revenue (Y5)</div></div>
    <div class="kpi kpi-red"><div class="value" id="kpi-costs">—</div><div class="label">Annual Costs (Y5)</div></div>
    <div class="kpi kpi-blue"><div class="value" id="kpi-net">—</div><div class="label">Net Surplus (Y5)</div></div>
    <div class="kpi"><div class="value" id="kpi-students">—</div><div class="label">Students (Y5)</div></div>
    <div class="kpi"><div class="value" id="kpi-staff">—</div><div class="label">Total Staff (Y5)</div></div>
    <div class="kpi"><div class="value" id="kpi-per-student">—</div><div class="label">Rev/Student (Y5)</div></div>
  </div>

  <div class="card" style="margin-bottom:12px;">
    <div class="card-head gold">REVENUE vs COST — 7 YEAR TRAJECTORY</div>
    <div class="card-body">
      <div style="display:flex;gap:14px;font-size:9px;margin-bottom:6px;font-weight:600;">
        <span><span style="display:inline-block;width:10px;height:10px;background:var(--md-green);border-radius:2px;vertical-align:middle;"></span> Revenue</span>
        <span><span style="display:inline-block;width:10px;height:10px;background:var(--red);border-radius:2px;vertical-align:middle;"></span> Costs</span>
        <span style="margin-left:auto;font-weight:800;" id="chart-legend"></span>
      </div>
      <div class="mini-chart" id="mini-chart"></div>
    </div>
  </div>

  <div>
    <div class="tab-bar">
      <button class="tab-btn active" onclick="switchTab(0)">ENROLLMENT &amp; SECTIONS</button>
      <button class="tab-btn" onclick="switchTab(1)">REVENUE PROJECTION</button>
      <button class="tab-btn" onclick="switchTab(2)">STAFFING &amp; COSTS</button>
      <button class="tab-btn" onclick="switchTab(3)">PROFIT &amp; LOSS</button>
    </div>
    <div class="card" style="border-radius:0 0 var(--radius) var(--radius);">
      <div class="card-body" style="padding:0;">
        <div class="tab-content active" id="tab-0"><div class="proj-wrap"><table class="proj-table" id="tbl-enrollment"></table></div></div>
        <div class="tab-content" id="tab-1"><div class="proj-wrap"><table class="proj-table" id="tbl-revenue"></table></div></div>
        <div class="tab-content" id="tab-2"><div class="proj-wrap"><table class="proj-table" id="tbl-staffing"></table></div></div>
        <div class="tab-content" id="tab-3"><div class="proj-wrap"><table class="proj-table" id="tbl-pnl"></table></div></div>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════ RIGHT PANEL ═══════════ -->
<div>
  <div class="card">
    <div class="card-head">SELECT YEAR FOR DETAIL</div>
    <div class="card-body"><div class="year-selector" id="year-selector"></div></div>
  </div>

  <!-- Health Check -->
  <div class="card">
    <div class="card-head teal">KSA FINANCIAL HEALTH CHECK</div>
    <div class="card-body" id="health-check"></div>
  </div>

  <div class="card">
    <div class="card-head gold">REVENUE BREAKDOWN</div>
    <div class="card-body" id="rev-breakdown"></div>
  </div>

  <div class="card">
    <div class="card-head red">COST BREAKDOWN</div>
    <div class="card-body" id="cost-breakdown"></div>
  </div>

  <div class="card">
    <div class="card-head blue">STAFFING REQUIREMENTS</div>
    <div class="card-body" id="staff-detail"></div>
  </div>

  <div class="card">
    <div class="card-head orange">WHERE NEW HIRING HAPPENS</div>
    <div class="card-body" id="hiring-map"></div>
  </div>

  <div class="card">
    <div class="card-head purple">PER-STUDENT ECONOMICS</div>
    <div class="card-body" id="per-student"></div>
  </div>

  <div class="disclaimer">
    All figures are planning-level estimates in SAR. KSA benchmarks based on community international school
    data (Riyadh, 2024-25). Staff costs include benefits multiplier. 1 USD = 3.75 SAR.
    TBC = Tatweer Building Company Category A.
  </div>
</div>

</div></div>

<div class="footer">CONFIDENTIAL | Pakistan International School (English Section), Riyadh | Revenue Projection Simulator v2.0 | 2025</div>

<script>
// ═══════════════════════════════════════════════════════════
// ENGINE
// ═══════════════════════════════════════════════════════════
const SAR_TO_USD = 1/3.75, NUM_YEARS = 7;

const GRADES = [
  {id:'nursery',  name:'Nursery',  segment:'EY', current:122, defaultFee:6000,  ksaLo:4000,  ksaHi:10000},
  {id:'reception',name:'Reception',segment:'EY', current:296, defaultFee:7000,  ksaLo:5000,  ksaHi:11000},
  {id:'kg',       name:'KG',       segment:'EY', current:383, defaultFee:8000,  ksaLo:6000,  ksaHi:12000},
  {id:'g1',       name:'Grade 1',  segment:'PRI',current:394, defaultFee:9500,  ksaLo:7000,  ksaHi:14000},
  {id:'g2',       name:'Grade 2',  segment:'PRI',current:417, defaultFee:10000, ksaLo:7000,  ksaHi:14000},
  {id:'g3',       name:'Grade 3',  segment:'PRI',current:398, defaultFee:10000, ksaLo:7000,  ksaHi:14000},
  {id:'g4',       name:'Grade 4',  segment:'PRI',current:430, defaultFee:10500, ksaLo:8000,  ksaHi:15000},
  {id:'g5',       name:'Grade 5',  segment:'INT',current:422, defaultFee:11000, ksaLo:9000,  ksaHi:17000},
  {id:'g6',       name:'Grade 6',  segment:'INT',current:468, defaultFee:11500, ksaLo:9000,  ksaHi:17000},
  {id:'g7',       name:'Grade 7',  segment:'INT',current:429, defaultFee:12000, ksaLo:10000, ksaHi:18000},
  {id:'g8',       name:'Grade 8',  segment:'INT',current:381, defaultFee:12500, ksaLo:10000, ksaHi:18000},
  {id:'g9',       name:'Grade 9',  segment:'INT',current:351, defaultFee:13000, ksaLo:10000, ksaHi:18000},
  {id:'g10',      name:'Grade 10', segment:'SEC',current:330, defaultFee:14000, ksaLo:11000, ksaHi:22000},
  {id:'g11',      name:'Grade 11', segment:'SEC',current:253, defaultFee:15000, ksaLo:12000, ksaHi:24000},
  {id:'g12',      name:'Grade 12', segment:'SEC',current:189, defaultFee:16000, ksaLo:13000, ksaHi:25000},
];
const CURRENT_TOTAL = GRADES.reduce((s,g)=>s+g.current,0);
const SEGMENTS = ['EY','PRI','INT','SEC'];
const SEG_NAMES = {EY:'Early Years',PRI:'Primary',INT:'Intermediate',SEC:'Secondary'};
const SEG_GRADES = {}; SEGMENTS.forEach(s => SEG_GRADES[s] = GRADES.filter(g=>g.segment===s));
const TEACHER_RATIO = {EY:1.0,PRI:1.15,INT:1.35,SEC:1.45};

const OTHER_FEE_TYPES = [
  {id:'books',       name:'Books & Materials',   defaults:{EY:800, PRI:1500,INT:2000,SEC:2500}},
  {id:'registration',name:'Registration (New)',  defaults:{EY:500, PRI:500, INT:750, SEC:1000}},
  {id:'transport',   name:'Transport',           defaults:{EY:3000,PRI:3000,INT:3000,SEC:3000}},
  {id:'uniform',     name:'Uniform',             defaults:{EY:600, PRI:600, INT:700, SEC:700}},
  {id:'sports',      name:'Sports & Activities', defaults:{EY:300, PRI:500, INT:600, SEC:600}},
  {id:'cafeteria',   name:'Cafeteria / Meals',   defaults:{EY:0,   PRI:400, INT:500, SEC:500}},
];

// KSA Benchmarks
const KSA = {
  staffPctHealthy: 60, staffPctCaution: 70, staffPctDanger: 75,
  netMarginStrong: 15, netMarginOk: 8, netMarginWeak: 3,
  collectionGood: 92, collectionFair: 88,
  strEY: {lo:10,hi:15}, strPRI: {lo:15,hi:20}, strINT: {lo:18,hi:22}, strSEC: {lo:18,hi:25},
  opexPerStudent: {lo:2800, hi:4200},
  teacherSal: {lo:4000, hi:7000},
};

const $ = id => document.getElementById(id);
function fmt(n){return Math.round(n).toLocaleString('en-US');}
function fmtM(n){return (n/1e6).toFixed(1)+'M';}
function fmtK(n){return (n/1e3).toFixed(0)+'K';}
function fmtSAR(n){return 'SAR '+fmt(n);}
let selectedYear = 5;

// ── BUILD INPUTS ──────────────────────────────
function buildTuitionTable(){
  let html='', lastSeg='';
  for(const g of GRADES){
    if(g.segment!==lastSeg){ html+=`<tr class="seg-head"><td colspan="4">${SEG_NAMES[g.segment]}</td></tr>`; lastSeg=g.segment; }
    html+=`<tr>
      <td>${g.name}</td>
      <td><input type="number" id="students-${g.id}" value="${g.current}" min="0" step="10" style="width:54px;"></td>
      <td><input type="number" id="fee-${g.id}" value="${g.defaultFee}" min="0" step="500"></td>
      <td class="bm-cell">${(g.ksaLo/1000).toFixed(0)}K-${(g.ksaHi/1000).toFixed(0)}K</td>
    </tr>`;
  }
  $('tuition-tbody').innerHTML=html;
}

function buildOtherFeesTable(){
  let html='';
  for(const ft of OTHER_FEE_TYPES){
    html+=`<tr><td>${ft.name}</td>${SEGMENTS.map(s=>`<td><input type="number" id="ofee-${ft.id}-${s}" value="${ft.defaults[s]}" min="0" step="100"></td>`).join('')}</tr>`;
  }
  $('other-fees-tbody').innerHTML=html;
}

function buildYearSelector(){
  let html='';
  for(let y=0;y<NUM_YEARS;y++) html+=`<button class="year-btn ${y===selectedYear?'active':''}" onclick="selectYear(${y})">Y${y}</button>`;
  $('year-selector').innerHTML=html;
}
function selectYear(y){ selectedYear=y; document.querySelectorAll('.year-btn').forEach((b,i)=>b.classList.toggle('active',i===y)); recalc(); }
function toggleCard(h){ const b=h.nextElementSibling; b.classList.toggle('collapsed'); const t=h.querySelector('.toggle'); if(t)t.innerHTML=b.classList.contains('collapsed')?'&#9654;':'&#9660;'; }
function switchTab(i){ document.querySelectorAll('.tab-btn').forEach((b,j)=>b.classList.toggle('active',j===i)); document.querySelectorAll('.tab-content').forEach((c,j)=>c.classList.toggle('active',j===i)); }

// ── CALCULATION ────────────────────────────────
function readInputs(){
  const c={};
  c.targetTotal=+$('sl-target').value; c.growthYears=+$('sl-growth-yrs').value;
  c.maxCls=+$('sl-max-cls').value; c.eyCls=+$('sl-ey-cls').value;
  c.discount=+$('sl-discount').value/100; c.discountYears=+$('sl-disc-yrs').value;
  c.transportUtil=+$('sl-transport-util').value/100; c.sportsOptin=+$('sl-sports-optin').value/100;
  c.teacherSal=+$('sl-teacher-sal').value; c.seniorSal=+$('sl-senior-sal').value;
  c.adminSal=+$('sl-admin-sal').value; c.supportSal=+$('sl-support-sal').value;
  c.benefits=+$('sl-benefits').value;
  c.utilities=+$('sl-utilities').value; c.maintenance=+$('sl-maintenance').value;
  c.materials=+$('sl-materials').value; c.overhead=+$('sl-overhead').value;
  c.collection=+$('sl-collection').value/100;
  c.baseStudents={}; c.baseTotal=0;
  for(const g of GRADES){ c.baseStudents[g.id]=+(document.getElementById('students-'+g.id)?.value||g.current); c.baseTotal+=c.baseStudents[g.id]; }
  c.tuition={};
  for(const g of GRADES) c.tuition[g.id]=+(document.getElementById('fee-'+g.id)?.value||g.defaultFee);
  c.otherFees={};
  for(const ft of OTHER_FEE_TYPES){ c.otherFees[ft.id]={}; for(const s of SEGMENTS) c.otherFees[ft.id][s]=+(document.getElementById('ofee-'+ft.id+'-'+s)?.value||ft.defaults[s]); }
  return c;
}

function calcEnrollment(cfg){
  const bt=cfg.baseTotal||CURRENT_TOTAL, yrs=[];
  for(let y=0;y<NUM_YEARS;y++){
    let total=y===0?bt:y>=cfg.growthYears?cfg.targetTotal:bt+(cfg.targetTotal-bt)*(y/cfg.growthYears);
    const e={}; let assigned=0;
    for(let i=0;i<GRADES.length-1;i++){const g=GRADES[i]; e[g.id]=Math.round(total*(cfg.baseStudents[g.id]||g.current)/Math.max(1,bt)); assigned+=e[g.id];}
    e[GRADES[GRADES.length-1].id]=Math.round(total)-assigned;
    e._total=Math.round(total);
    for(const s of SEGMENTS) e['_'+s]=SEG_GRADES[s].reduce((sum,g)=>sum+e[g.id],0);
    yrs.push(e);
  }
  return yrs;
}

function calcSections(enrollment,cfg){
  const yrs=[];
  for(let y=0;y<NUM_YEARS;y++){
    const s={}; let total=0;
    for(const g of GRADES){const mx=g.segment==='EY'?cfg.eyCls:cfg.maxCls; s[g.id]=Math.ceil(enrollment[y][g.id]/mx); total+=s[g.id];}
    s._total=total;
    for(const seg of SEGMENTS) s['_'+seg]=SEG_GRADES[seg].reduce((sum,g)=>sum+s[g.id],0);
    yrs.push(s);
  }
  return yrs;
}

function calcStaff(sections,enrollment,cfg){
  const yrs=[];
  for(let y=0;y<NUM_YEARS;y++){
    const st={}; let tt=0;
    for(const s of SEGMENTS){const t=Math.ceil(sections[y]['_'+s]*TEACHER_RATIO[s]); st['teachers_'+s]=t; tt+=t;}
    st.teachers=tt; st.seniors=Math.ceil(sections[y]._total/10);
    st.admin=Math.ceil(enrollment[y]._total/100); st.support=Math.ceil(enrollment[y]._total/150);
    st.total=st.teachers+st.seniors+st.admin+st.support;
    if(y>0){
      st.newTeachers=Math.max(0,st.teachers-yrs[y-1].teachers);
      st.newSeniors=Math.max(0,st.seniors-yrs[y-1].seniors);
      st.newAdmin=Math.max(0,st.admin-yrs[y-1].admin);
      st.newSupport=Math.max(0,st.support-yrs[y-1].support);
      st.newTotal=st.newTeachers+st.newSeniors+st.newAdmin+st.newSupport;
      for(const s of SEGMENTS) st['newTeachers_'+s]=Math.max(0,st['teachers_'+s]-yrs[y-1]['teachers_'+s]);
      for(const g of GRADES) st['deltaSec_'+g.id]=Math.max(0,sections[y][g.id]-sections[y-1][g.id]);
    } else {
      st.newTeachers=0;st.newSeniors=0;st.newAdmin=0;st.newSupport=0;st.newTotal=0;
      for(const s of SEGMENTS) st['newTeachers_'+s]=0;
      for(const g of GRADES) st['deltaSec_'+g.id]=0;
    }
    yrs.push(st);
  }
  return yrs;
}

function calcRevenue(enrollment,cfg){
  const yrs=[];
  for(let y=0;y<NUM_YEARS;y++){
    const r={};
    const dr=(y>=1&&y<=cfg.discountYears)?cfg.discount:0;
    let gt=0; for(const g of GRADES) gt+=enrollment[y][g.id]*cfg.tuition[g.id];
    r.grossTuition=gt; r.discountAmount=gt*dr; r.netTuition=gt-r.discountAmount; r.discountRate=dr;
    for(const s of SEGMENTS) r['tuition_'+s]=SEG_GRADES[s].reduce((sum,g)=>sum+enrollment[y][g.id]*cfg.tuition[g.id],0);
    r.books=0;r.registration=0;r.transport=0;r.uniform=0;r.sports=0;r.cafeteria=0;
    for(const g of GRADES){
      const s=g.segment, n=enrollment[y][g.id];
      r.books+=n*cfg.otherFees.books[s]; r.uniform+=n*cfg.otherFees.uniform[s];
      r.transport+=n*cfg.otherFees.transport[s]*cfg.transportUtil;
      r.sports+=n*cfg.otherFees.sports[s]*cfg.sportsOptin;
      r.cafeteria+=n*cfg.otherFees.cafeteria[s];
      const prev=y>0?enrollment[y-1][g.id]:0;
      r.registration+=Math.max(0,y===0?0:n-prev)*cfg.otherFees.registration[s];
    }
    r.otherTotal=r.books+r.registration+r.transport+r.uniform+r.sports+r.cafeteria;
    r.grossRevenue=r.grossTuition+r.otherTotal; r.totalRevenue=r.netTuition+r.otherTotal;
    r.collectedRevenue=r.totalRevenue*cfg.collection;
    yrs.push(r);
  }
  return yrs;
}

function calcCosts(staff,enrollment,cfg){
  const yrs=[];
  for(let y=0;y<NUM_YEARS;y++){
    const c={}, n=enrollment[y]._total, b=cfg.benefits;
    c.teacherCost=staff[y].teachers*cfg.teacherSal*12*b;
    c.seniorCost=staff[y].seniors*cfg.seniorSal*12*b;
    c.adminCost=staff[y].admin*cfg.adminSal*12*b;
    c.supportCost=staff[y].support*cfg.supportSal*12*b;
    c.totalStaffCost=c.teacherCost+c.seniorCost+c.adminCost+c.supportCost;
    c.utilities=n*cfg.utilities; c.maintenance=n*cfg.maintenance;
    c.materials=n*cfg.materials; c.overhead=n*cfg.overhead;
    c.totalOpsCost=c.utilities+c.maintenance+c.materials+c.overhead;
    c.totalCost=c.totalStaffCost+c.totalOpsCost;
    yrs.push(c);
  }
  return yrs;
}

// ── RENDERING ──────────────────────────────────
function yH(){let h='<th>Item</th>';for(let y=0;y<NUM_YEARS;y++)h+=`<th>Y${y}${y===0?' (Now)':''}</th>`;return `<thead><tr>${h}</tr></thead>`;}
function yC(vals){return vals.map(v=>`<td>${fmt(v)}</td>`).join('');}

function renderEnrollmentTab(enrollment,sections,staff){
  let html=yH()+'<tbody>';
  for(const s of SEGMENTS){
    html+=`<tr class="seg-head"><td colspan="${NUM_YEARS+1}">${SEG_NAMES[s]}</td></tr>`;
    for(const g of SEG_GRADES[s]){
      html+='<tr><td>'+g.name+'</td>';
      for(let y=0;y<NUM_YEARS;y++){
        const n=enrollment[y][g.id],sec=sections[y][g.id],d=y>0?staff[y]['deltaSec_'+g.id]:0;
        html+=`<td>${fmt(n)} <span style="color:var(--md-grey);font-size:8px;">[${sec}]${d>0?' <span class="new-hire">(+'+d+'s)</span>':''}</span></td>`;
      }
      html+='</tr>';
    }
    html+=`<tr class="subtotal-row"><td>${SEG_NAMES[s]} Total</td>`;
    for(let y=0;y<NUM_YEARS;y++) html+=`<td>${fmt(enrollment[y]['_'+s])} <span style="font-size:8px;">[${sections[y]['_'+s]}]</span></td>`;
    html+='</tr>';
  }
  html+=`<tr class="total-row"><td>TOTAL ENROLLMENT</td>`;
  for(let y=0;y<NUM_YEARS;y++) html+=`<td>${fmt(enrollment[y]._total)} <span style="color:var(--gold);font-size:8px;">[${sections[y]._total} sec]</span></td>`;
  html+='</tr>';
  html+=`<tr style="background:var(--lt-orange);"><td style="font-weight:800;color:var(--orange);">New Sections Added</td>`;
  for(let y=0;y<NUM_YEARS;y++){const d=y>0?sections[y]._total-sections[y-1]._total:0; html+=`<td style="font-weight:800;color:${d>0?'var(--orange)':'var(--md-grey)'};">${d>0?'+'+d:'—'}</td>`;}
  html+='</tr></tbody>';
  $('tbl-enrollment').innerHTML=html;
}

function renderRevenueTab(revenue){
  let html=yH()+'<tbody>';
  html+=`<tr class="seg-head"><td colspan="${NUM_YEARS+1}">TUITION REVENUE</td></tr>`;
  for(const s of SEGMENTS) html+=`<tr><td>${SEG_NAMES[s]} Tuition</td>${yC(revenue.map(r=>r['tuition_'+s]))}</tr>`;
  html+=`<tr class="subtotal-row"><td>Gross Tuition</td>${yC(revenue.map(r=>r.grossTuition))}</tr>`;
  html+=`<tr class="discount-row"><td>New Building Discount</td>`;
  for(let y=0;y<NUM_YEARS;y++){const r=revenue[y]; html+=`<td>${r.discountAmount>0?'('+fmt(r.discountAmount)+') ['+(r.discountRate*100).toFixed(0)+'%]':'—'}</td>`;}
  html+='</tr>';
  html+=`<tr class="subtotal-row"><td>Net Tuition</td>${yC(revenue.map(r=>r.netTuition))}</tr>`;
  html+=`<tr class="seg-head"><td colspan="${NUM_YEARS+1}">OTHER REVENUE</td></tr>`;
  html+=`<tr><td>Books &amp; Materials</td>${yC(revenue.map(r=>r.books))}</tr>`;
  html+=`<tr><td>Registration (New Students)</td>${yC(revenue.map(r=>r.registration))}</tr>`;
  html+=`<tr><td>Transport</td>${yC(revenue.map(r=>r.transport))}</tr>`;
  html+=`<tr><td>Uniform</td>${yC(revenue.map(r=>r.uniform))}</tr>`;
  html+=`<tr><td>Sports &amp; Activities</td>${yC(revenue.map(r=>r.sports))}</tr>`;
  html+=`<tr><td>Cafeteria / Meals</td>${yC(revenue.map(r=>r.cafeteria))}</tr>`;
  html+=`<tr class="subtotal-row"><td>Other Revenue Total</td>${yC(revenue.map(r=>r.otherTotal))}</tr>`;
  html+=`<tr class="seg-head"><td colspan="${NUM_YEARS+1}">TOTALS</td></tr>`;
  html+=`<tr class="revenue-row"><td>Total Revenue (After Discount)</td>${yC(revenue.map(r=>r.totalRevenue))}</tr>`;
  html+=`<tr class="total-row"><td>Collected Revenue</td>${yC(revenue.map(r=>r.collectedRevenue))}</tr>`;
  html+='</tbody>';
  $('tbl-revenue').innerHTML=html;
}

function renderStaffingTab(staff,sections,costs){
  let html=yH()+'<tbody>';
  html+=`<tr class="seg-head"><td colspan="${NUM_YEARS+1}">SECTIONS BY SEGMENT</td></tr>`;
  for(const s of SEGMENTS){
    html+=`<tr><td>${SEG_NAMES[s]}</td>`;
    for(let y=0;y<NUM_YEARS;y++){const v=sections[y]['_'+s],d=y>0?v-sections[y-1]['_'+s]:0; html+=`<td>${v}${d>0?' <span class="new-hire">(+'+d+')</span>':''}</td>`;}
    html+='</tr>';
  }
  html+=`<tr class="subtotal-row"><td>Total Sections</td>`;for(let y=0;y<NUM_YEARS;y++)html+=`<td>${sections[y]._total}</td>`;html+='</tr>';

  html+=`<tr class="seg-head"><td colspan="${NUM_YEARS+1}">STAFF REQUIREMENTS</td></tr>`;
  for(const s of SEGMENTS){
    html+=`<tr><td>${SEG_NAMES[s]} Teachers</td>`;
    for(let y=0;y<NUM_YEARS;y++){const v=staff[y]['teachers_'+s],nw=staff[y]['newTeachers_'+s]; html+=`<td>${v}${nw>0?' <span class="new-hire">(+'+nw+')</span>':''}</td>`;}
    html+='</tr>';
  }
  html+=`<tr class="subtotal-row"><td>Total Teachers</td>${yC(staff.map(s=>s.teachers))}</tr>`;
  html+=`<tr><td>Senior / HODs</td>${yC(staff.map(s=>s.seniors))}</tr>`;
  html+=`<tr><td>Admin Staff</td>${yC(staff.map(s=>s.admin))}</tr>`;
  html+=`<tr><td>Support Staff</td>${yC(staff.map(s=>s.support))}</tr>`;
  html+=`<tr class="total-row"><td>TOTAL STAFF</td>${yC(staff.map(s=>s.total))}</tr>`;

  html+=`<tr class="seg-head"><td colspan="${NUM_YEARS+1}">NEW HIRES PER YEAR</td></tr>`;
  html+=`<tr><td>New Teachers</td>`; for(let y=0;y<NUM_YEARS;y++){const v=staff[y].newTeachers; html+=`<td class="${v>0?'new-hire':''}">${v>0?'+'+v:'—'}</td>`;} html+='</tr>';
  html+=`<tr class="subtotal-row"><td>Total New Hires</td>`+staff.map(s=>`<td style="color:${s.newTotal>0?'var(--red)':''};font-weight:800;">${s.newTotal>0?'+'+s.newTotal:'—'}</td>`).join('')+'</tr>';

  html+=`<tr class="seg-head"><td colspan="${NUM_YEARS+1}">ANNUAL COSTS (SAR)</td></tr>`;
  html+=`<tr><td>Teacher Salaries</td>${yC(costs.map(c=>c.teacherCost))}</tr>`;
  html+=`<tr><td>Senior / HOD Salaries</td>${yC(costs.map(c=>c.seniorCost))}</tr>`;
  html+=`<tr><td>Admin Salaries</td>${yC(costs.map(c=>c.adminCost))}</tr>`;
  html+=`<tr><td>Support Salaries</td>${yC(costs.map(c=>c.supportCost))}</tr>`;
  html+=`<tr class="subtotal-row"><td>Total Staff Cost</td>${yC(costs.map(c=>c.totalStaffCost))}</tr>`;
  html+=`<tr><td>Utilities</td>${yC(costs.map(c=>c.utilities))}</tr>`;
  html+=`<tr><td>Maintenance</td>${yC(costs.map(c=>c.maintenance))}</tr>`;
  html+=`<tr><td>Materials</td>${yC(costs.map(c=>c.materials))}</tr>`;
  html+=`<tr><td>Overhead</td>${yC(costs.map(c=>c.overhead))}</tr>`;
  html+=`<tr class="subtotal-row"><td>Total Ops Cost</td>${yC(costs.map(c=>c.totalOpsCost))}</tr>`;
  html+=`<tr class="total-row"><td>TOTAL ANNUAL COST</td>${yC(costs.map(c=>c.totalCost))}</tr>`;
  html+='</tbody>';
  $('tbl-staffing').innerHTML=html;
}

function renderPnLTab(revenue,costs,enrollment){
  let html=yH()+'<tbody>';
  html+=`<tr class="seg-head"><td colspan="${NUM_YEARS+1}">PROFIT &amp; LOSS SUMMARY</td></tr>`;
  html+=`<tr class="revenue-row"><td>Gross Revenue</td>${yC(revenue.map(r=>r.grossRevenue))}</tr>`;
  html+=`<tr class="discount-row"><td>Less: Building Discount</td>`;
  for(let y=0;y<NUM_YEARS;y++){const d=revenue[y].discountAmount; html+=`<td>${d>0?'('+fmt(d)+')':'—'}</td>`;}html+='</tr>';
  html+=`<tr><td>Less: Collection Loss</td>`;
  for(let y=0;y<NUM_YEARS;y++){const l=revenue[y].totalRevenue-revenue[y].collectedRevenue; html+=`<td style="color:var(--red);">${l>0?'('+fmt(l)+')':'—'}</td>`;}html+='</tr>';
  html+=`<tr class="subtotal-row"><td>Collected Revenue</td>${yC(revenue.map(r=>r.collectedRevenue))}</tr>`;

  html+=`<tr class="seg-head"><td colspan="${NUM_YEARS+1}">COSTS</td></tr>`;
  html+=`<tr><td>Staff Costs</td>${yC(costs.map(c=>c.totalStaffCost))}</tr>`;
  html+=`<tr><td>Operational Costs</td>${yC(costs.map(c=>c.totalOpsCost))}</tr>`;
  html+=`<tr class="cost-row"><td>Total Costs</td>${yC(costs.map(c=>c.totalCost))}</tr>`;

  html+=`<tr class="seg-head"><td colspan="${NUM_YEARS+1}">NET POSITION</td></tr>`;
  let cum=0;
  const nets=[],cums=[];
  for(let y=0;y<NUM_YEARS;y++){const n=revenue[y].collectedRevenue-costs[y].totalCost; nets.push(n); cum+=n; cums.push(cum);}
  html+=`<tr class="net-row"><td>Annual Surplus / (Deficit)</td>`;
  for(const n of nets) html+=`<td style="color:${n>=0?'var(--gold)':'#FF8A80'};">${n>=0?fmt(n):'('+fmt(Math.abs(n))+')'}</td>`;
  html+='</tr>';
  html+=`<tr class="net-row"><td>Cumulative Surplus</td>`;
  for(const c of cums) html+=`<td style="color:${c>=0?'var(--gold)':'#FF8A80'};">${c>=0?fmt(c):'('+fmt(Math.abs(c))+')'}</td>`;
  html+='</tr>';

  html+=`<tr class="seg-head"><td colspan="${NUM_YEARS+1}">KEY RATIOS vs KSA BENCHMARKS</td></tr>`;
  html+=`<tr><td>Staff Cost % of Revenue</td>`;
  for(let y=0;y<NUM_YEARS;y++){
    const p=revenue[y].collectedRevenue>0?(costs[y].totalStaffCost/revenue[y].collectedRevenue*100):0;
    html+=`<td style="font-weight:800;color:${p>KSA.staffPctDanger?'var(--red)':p>KSA.staffPctCaution?'var(--orange)':'var(--md-green)'};">${p.toFixed(1)}%</td>`;
  }
  html+='</tr>';
  html+=`<tr><td>Net Margin %</td>`;
  for(let y=0;y<NUM_YEARS;y++){
    const m=revenue[y].collectedRevenue>0?(nets[y]/revenue[y].collectedRevenue*100):0;
    html+=`<td style="font-weight:800;color:${m>=KSA.netMarginStrong?'var(--md-green)':m>=KSA.netMarginOk?'var(--blue)':m>=KSA.netMarginWeak?'var(--orange)':'var(--red)'};">${m.toFixed(1)}%</td>`;
  }
  html+='</tr>';
  html+=`<tr><td>Revenue per Student</td>`;
  for(let y=0;y<NUM_YEARS;y++) html+=`<td>${fmt(enrollment[y]._total>0?revenue[y].collectedRevenue/enrollment[y]._total:0)}</td>`;
  html+='</tr>';
  html+=`<tr><td>Cost per Student</td>`;
  for(let y=0;y<NUM_YEARS;y++) html+=`<td>${fmt(enrollment[y]._total>0?costs[y].totalCost/enrollment[y]._total:0)}</td>`;
  html+='</tr>';
  html+='</tbody>';
  $('tbl-pnl').innerHTML=html;
}

function renderMiniChart(revenue,costs){
  let html='';
  const mx=Math.max(...revenue.map(r=>r.collectedRevenue),...costs.map(c=>c.totalCost))||1;
  for(let y=0;y<NUM_YEARS;y++){
    const rp=(revenue[y].collectedRevenue/mx*100).toFixed(1), cp=(costs[y].totalCost/mx*100).toFixed(1);
    const net=revenue[y].collectedRevenue-costs[y].totalCost;
    html+=`<div class="bar-row"><div class="bar-label">Y${y}</div><div style="flex:1;"><div style="display:flex;height:10px;gap:1px;margin-bottom:1px;"><div class="bar-rev" style="width:${rp}%;background:var(--md-green);border-radius:2px;display:flex;align-items:center;justify-content:center;color:white;font-size:7px;font-weight:800;overflow:hidden;">${revenue[y].collectedRevenue>mx*0.15?fmtM(revenue[y].collectedRevenue):''}</div></div><div style="display:flex;height:10px;gap:1px;"><div style="width:${cp}%;background:var(--red);border-radius:2px;display:flex;align-items:center;justify-content:center;color:white;font-size:7px;font-weight:800;overflow:hidden;">${costs[y].totalCost>mx*0.15?fmtM(costs[y].totalCost):''}</div></div></div><div style="width:52px;text-align:right;font-size:8px;font-weight:800;color:${net>=0?'var(--md-green)':'var(--red)'};">${net>=0?'+':''}${fmtM(net)}</div></div>`;
  }
  $('mini-chart').innerHTML=html;
}

function renderHealthCheck(y,revenue,costs,staff,enrollment){
  const rev=revenue[y], cost=costs[y], st=staff[y], enrol=enrollment[y]._total;
  const staffPct=rev.collectedRevenue>0?(cost.totalStaffCost/rev.collectedRevenue*100):0;
  const net=rev.collectedRevenue-cost.totalCost;
  const netMargin=rev.collectedRevenue>0?(net/rev.collectedRevenue*100):0;
  const opex=enrol>0?cost.totalOpsCost/enrol:0;
  const str=st.teachers>0?enrol/st.teachers:0;
  const coll=(rev.totalRevenue>0?rev.collectedRevenue/rev.totalRevenue:0)*100;

  function healthBar(val,lo,hi,invert){
    let pct,color;
    if(invert){pct=Math.min(100,Math.max(0,(hi-val)/(hi-lo)*100)); color=val<=lo?'var(--md-green)':val<=hi?'var(--orange)':'var(--red)';}
    else{pct=Math.min(100,Math.max(0,(val-lo)/(hi-lo)*100)); color=val>=hi?'var(--md-green)':val>=lo?'var(--orange)':'var(--red)';}
    return `<div class="health-bar"><div class="health-fill" style="width:${Math.max(8,pct)}%;background:${color};"></div></div>`;
  }

  let h='';
  // Staff Cost %
  const sc=staffPct<=KSA.staffPctHealthy?'var(--md-green)':staffPct<=KSA.staffPctCaution?'var(--orange)':'var(--red)';
  h+=`<div class="health-row"><div class="health-metric">Staff Cost % of Rev<br><span class="health-std">KSA target: &lt;${KSA.staffPctHealthy}%</span></div>${healthBar(staffPct,KSA.staffPctHealthy,KSA.staffPctDanger,true)}<div class="health-val" style="color:${sc};">${staffPct.toFixed(1)}%</div></div>`;

  // Net Margin
  const nm=netMargin>=KSA.netMarginStrong?'var(--md-green)':netMargin>=KSA.netMarginOk?'var(--blue)':netMargin>=KSA.netMarginWeak?'var(--orange)':'var(--red)';
  h+=`<div class="health-row"><div class="health-metric">Net Margin<br><span class="health-std">KSA target: &gt;${KSA.netMarginOk}%</span></div>${healthBar(netMargin,KSA.netMarginWeak,KSA.netMarginStrong,false)}<div class="health-val" style="color:${nm};">${netMargin.toFixed(1)}%</div></div>`;

  // Collection Rate
  const cr=coll>=KSA.collectionGood?'var(--md-green)':coll>=KSA.collectionFair?'var(--orange)':'var(--red)';
  h+=`<div class="health-row"><div class="health-metric">Fee Collection<br><span class="health-std">KSA good: &gt;${KSA.collectionGood}%</span></div>${healthBar(coll,KSA.collectionFair,98,false)}<div class="health-val" style="color:${cr};">${coll.toFixed(0)}%</div></div>`;

  // OPEX per student
  const oc=opex<=KSA.opexPerStudent.hi?'var(--md-green)':'var(--orange)';
  h+=`<div class="health-row"><div class="health-metric">OPEX / Student<br><span class="health-std">KSA range: ${fmtK(KSA.opexPerStudent.lo)}-${fmtK(KSA.opexPerStudent.hi)}</span></div>${healthBar(opex,KSA.opexPerStudent.lo,KSA.opexPerStudent.hi,true)}<div class="health-val" style="color:${oc};">${fmtK(opex)}</div></div>`;

  // Student:Teacher
  const strc=str>=15&&str<=22?'var(--md-green)':str>=12&&str<=25?'var(--orange)':'var(--red)';
  h+=`<div class="health-row"><div class="health-metric">Student:Teacher<br><span class="health-std">KSA optimal: 15-22:1</span></div>${healthBar(str,12,25,false)}<div class="health-val" style="color:${strc};">${str.toFixed(1)}:1</div></div>`;

  $('health-check').innerHTML=h;
}

function renderRightPanel(y,revenue,costs,staff,enrollment,sections){
  const rev=revenue[y],cost=costs[y],st=staff[y],net=rev.collectedRevenue-cost.totalCost,enrol=enrollment[y]._total;

  // Revenue
  let r='';
  r+=`<div class="summary-row"><span class="s-label">Gross Tuition</span><span class="s-val">${fmtSAR(rev.grossTuition)}</span></div>`;
  if(rev.discountAmount>0) r+=`<div class="summary-row deficit"><span class="s-label">Discount (${(rev.discountRate*100).toFixed(0)}%)</span><span class="s-val">-${fmtSAR(rev.discountAmount)}</span></div>`;
  r+=`<div class="summary-row"><span class="s-label">Books &amp; Materials</span><span class="s-val">${fmtSAR(rev.books)}</span></div>`;
  r+=`<div class="summary-row"><span class="s-label">Transport</span><span class="s-val">${fmtSAR(rev.transport)}</span></div>`;
  r+=`<div class="summary-row"><span class="s-label">Uniform</span><span class="s-val">${fmtSAR(rev.uniform)}</span></div>`;
  r+=`<div class="summary-row"><span class="s-label">Sports &amp; Activities</span><span class="s-val">${fmtSAR(rev.sports)}</span></div>`;
  r+=`<div class="summary-row"><span class="s-label">Cafeteria</span><span class="s-val">${fmtSAR(rev.cafeteria)}</span></div>`;
  r+=`<div class="summary-row"><span class="s-label">Registration</span><span class="s-val">${fmtSAR(rev.registration)}</span></div>`;
  r+=`<div class="summary-row grand"><span class="s-label">Collected Revenue</span><span class="s-val">SAR ${fmtM(rev.collectedRevenue)}</span></div>`;
  $('rev-breakdown').innerHTML=r;

  // Costs
  let c='';
  c+=`<div class="summary-row"><span class="s-label">Teachers</span><span class="s-val">${fmtSAR(cost.teacherCost)}</span></div>`;
  c+=`<div class="summary-row"><span class="s-label">Senior / HODs</span><span class="s-val">${fmtSAR(cost.seniorCost)}</span></div>`;
  c+=`<div class="summary-row"><span class="s-label">Admin</span><span class="s-val">${fmtSAR(cost.adminCost)}</span></div>`;
  c+=`<div class="summary-row"><span class="s-label">Support</span><span class="s-val">${fmtSAR(cost.supportCost)}</span></div>`;
  c+=`<div class="summary-row" style="border-top:2px solid var(--border);padding-top:4px;"><span class="s-label"><b>Ops: Utilities+Maint+Other</b></span><span class="s-val">${fmtSAR(cost.totalOpsCost)}</span></div>`;
  c+=`<div class="summary-row grand"><span class="s-label">Total Costs</span><span class="s-val">SAR ${fmtM(cost.totalCost)}</span></div>`;
  $('cost-breakdown').innerHTML=c;

  // Staff
  let s='';
  s+=`<div class="summary-row"><span class="s-label">Teachers</span><span class="s-val">${st.teachers}</span></div>`;
  s+=`<div class="summary-row"><span class="s-label">Senior / HODs</span><span class="s-val">${st.seniors}</span></div>`;
  s+=`<div class="summary-row"><span class="s-label">Admin</span><span class="s-val">${st.admin}</span></div>`;
  s+=`<div class="summary-row"><span class="s-label">Support</span><span class="s-val">${st.support}</span></div>`;
  s+=`<div class="summary-row" style="border-top:2px solid var(--dk-green);padding-top:4px;"><span class="s-label"><b>Total</b></span><span class="s-val" style="font-size:14px;">${st.total}</span></div>`;
  if(st.newTotal>0) s+=`<div class="summary-row"><span class="s-label" style="color:var(--red);"><b>New Hires Y${y}</b></span><span class="s-val" style="color:var(--red);">+${st.newTotal}</span></div>`;
  $('staff-detail').innerHTML=s;

  // Hiring map
  let h='';
  if(y===0){h='<div style="font-size:10px;color:var(--md-grey);text-align:center;padding:8px;">Y0 is baseline.</div>';}
  else{
    let any=false;
    for(const g of GRADES){const d=st['deltaSec_'+g.id]; if(d>0){any=true; h+=`<div class="hire-item"><span class="seg">${g.name} <span style="color:var(--md-grey);font-size:8px;">(+${d} sec)</span></span><span class="count">+${Math.ceil(d*TEACHER_RATIO[g.segment])} teacher${Math.ceil(d*TEACHER_RATIO[g.segment])>1?'s':''}</span></div>`;}}
    if(!any) h='<div style="font-size:10px;color:var(--md-grey);text-align:center;padding:8px;">No new sections in Y'+y+'.</div>';
    h+='<div style="margin-top:6px;border-top:1px solid #EEE;padding-top:6px;">';
    for(const seg of SEGMENTS){const nw=st['newTeachers_'+seg]; h+=`<div class="hire-item"><span class="seg">${SEG_NAMES[seg]}</span><span class="count ${nw===0?'zero':''}">${nw>0?'+'+nw:'—'}</span></div>`;}
    h+='</div>';
  }
  $('hiring-map').innerHTML=h;

  // Per-student
  const rps=enrol>0?rev.collectedRevenue/enrol:0, cps=enrol>0?cost.totalCost/enrol:0, nps=rps-cps;
  const staffPct=rev.collectedRevenue>0?(cost.totalStaffCost/rev.collectedRevenue*100):0;
  let p='';
  p+=`<div class="summary-row"><span class="s-label">Revenue / Student</span><span class="s-val">${fmtSAR(rps)}</span></div>`;
  p+=`<div class="summary-row"><span class="s-label">Cost / Student</span><span class="s-val">${fmtSAR(cps)}</span></div>`;
  p+=`<div class="summary-row ${nps>=0?'surplus':'deficit'}"><span class="s-label"><b>Net / Student</b></span><span class="s-val">${fmtSAR(nps)}</span></div>`;
  p+=`<div class="summary-row"><span class="s-label">Staff Cost %</span><span class="s-val" style="color:${staffPct>70?'var(--red)':staffPct>55?'var(--orange)':'var(--md-green)'};">${staffPct.toFixed(1)}%</span></div>`;
  p+=`<div class="summary-row"><span class="s-label">Student:Teacher</span><span class="s-val">${st.teachers>0?(enrol/st.teachers).toFixed(1):'—'}:1</span></div>`;
  $('per-student').innerHTML=p;

  renderHealthCheck(y,revenue,costs,staff,enrollment);
}

function updateLabels(cfg){
  $('lbl-target').textContent=fmt(cfg.targetTotal);
  $('lbl-growth-yrs').textContent=cfg.growthYears;
  $('lbl-max-cls').textContent=cfg.maxCls;
  $('lbl-ey-cls').textContent=cfg.eyCls;
  $('lbl-discount').textContent=(cfg.discount*100).toFixed(0)+'%';
  $('lbl-disc-yrs').textContent=cfg.discountYears;
  $('lbl-transport-util').textContent=(cfg.transportUtil*100).toFixed(0)+'%';
  $('lbl-sports-optin').textContent=(cfg.sportsOptin*100).toFixed(0)+'%';
  $('lbl-teacher-sal').textContent=fmt(cfg.teacherSal);
  $('lbl-senior-sal').textContent=fmt(cfg.seniorSal);
  $('lbl-admin-sal').textContent=fmt(cfg.adminSal);
  $('lbl-support-sal').textContent=fmt(cfg.supportSal);
  $('lbl-benefits').textContent=cfg.benefits.toFixed(2)+'\u00D7';
  $('lbl-utilities').textContent=fmt(cfg.utilities);
  $('lbl-maintenance').textContent=fmt(cfg.maintenance);
  $('lbl-materials').textContent=fmt(cfg.materials);
  $('lbl-overhead').textContent=fmt(cfg.overhead);
  $('lbl-collection').textContent=(cfg.collection*100).toFixed(0)+'%';

  // Dynamic benchmark coloring
  const ts=cfg.teacherSal;
  const bts=$('bm-teacher-sal');
  if(bts){bts.className='bm '+(ts>=KSA.teacherSal.lo&&ts<=KSA.teacherSal.hi?'bm-ok':ts<KSA.teacherSal.lo?'bm-warn':'bm-warn'); bts.innerHTML=(ts>=KSA.teacherSal.lo&&ts<=KSA.teacherSal.hi?'<span class="dot dot-g"></span>':'<span class="dot dot-y"></span>')+'KSA community school: SAR 4,000-7,000/mo';}
  const bc=$('bm-collection');
  if(bc){const cv=cfg.collection*100; bc.className='bm '+(cv>=KSA.collectionGood?'bm-ok':cv>=KSA.collectionFair?'bm-warn':'bm-bad'); bc.innerHTML=(cv>=KSA.collectionGood?'<span class="dot dot-g"></span>':cv>=KSA.collectionFair?'<span class="dot dot-y"></span>':'<span class="dot dot-r"></span>')+'KSA int\'l schools: 88-96% typical';}
  const bd=$('bm-discount');
  if(bd){const dv=cfg.discount*100; bd.className='bm '+(dv<=15?'bm-ok':dv<=20?'bm-warn':'bm-bad'); bd.innerHTML=(dv<=15?'<span class="dot dot-g"></span>':dv<=20?'<span class="dot dot-y"></span>':'<span class="dot dot-r"></span>')+'KSA new-campus norm: 5-15% for 2-3 yrs';}
}

// ── MAIN ──────────────────────────────────────
function recalc(){
  const cfg=readInputs(); updateLabels(cfg);
  const enrollment=calcEnrollment(cfg), sections=calcSections(enrollment,cfg);
  const staffData=calcStaff(sections,enrollment,cfg);
  const revenue=calcRevenue(enrollment,cfg), costs=calcCosts(staffData,enrollment,cfg);
  const ky=Math.min(cfg.growthYears,NUM_YEARS-1);

  $('kpi-revenue').textContent='SAR '+fmtM(revenue[ky].collectedRevenue);
  $('kpi-costs').textContent='SAR '+fmtM(costs[ky].totalCost);
  const kNet=revenue[ky].collectedRevenue-costs[ky].totalCost;
  $('kpi-net').textContent=(kNet>=0?'+':'')+'SAR '+fmtM(kNet);
  $('kpi-net').style.color=kNet>=0?'var(--md-green)':'var(--red)';
  $('kpi-students').textContent=fmt(enrollment[ky]._total);
  $('kpi-staff').textContent=fmt(staffData[ky].total);
  $('kpi-per-student').textContent='SAR '+fmtK(enrollment[ky]._total>0?revenue[ky].collectedRevenue/enrollment[ky]._total:0);
  document.querySelectorAll('#top-kpis .kpi .label').forEach(l=>{l.textContent=l.textContent.replace(/Y\d+/,'Y'+ky);});

  renderEnrollmentTab(enrollment,sections,staffData);
  renderRevenueTab(revenue);
  renderStaffingTab(staffData,sections,costs);
  renderPnLTab(revenue,costs,enrollment);
  renderMiniChart(revenue,costs);
  renderRightPanel(selectedYear,revenue,costs,staffData,enrollment,sections);

  const lastNet=revenue[NUM_YEARS-1].collectedRevenue-costs[NUM_YEARS-1].totalCost;
  $('chart-legend').textContent='Y'+(NUM_YEARS-1)+' Net: '+(lastNet>=0?'+':'')+'SAR '+fmtM(lastNet);
  $('chart-legend').style.color=lastNet>=0?'var(--md-green)':'var(--red)';
}

// ── INIT ──────────────────────────────────────
buildTuitionTable(); buildOtherFeesTable(); buildYearSelector();
document.querySelectorAll('input[type="range"]').forEach(sl=>sl.addEventListener('input',recalc));
let dt; function dr(){clearTimeout(dt);dt=setTimeout(recalc,200);}
document.querySelectorAll('input[type="number"]').forEach(i=>{i.addEventListener('input',dr);i.addEventListener('change',recalc);});
recalc();
</script>
</body>
</html>
